# ๐ Diagrama del Sistema de Mรณdulos por Usuario

## Estructura de Base de Datos

```
โโโโโโโโโโโโโโโโโโโโ
โ  tbl_usuarios    โ
โ                  โ
โ  - usn_id (PK)   โ
โ  - usn_nombre    โ
โ  - usn_rol_id    โโโโ
โ  - ...           โ  โ
โโโโโโโโโโโโโโโโโโโโ  โ
         โ            โ
         โ            โ
         โผ            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโ
โ  tbl_usuarios_modulos        โ      โ  tbl_roles      โ
โ                              โ      โ                 โ
โ  - usm_id (PK)               โ      โ  - rol_id (PK)  โ
โ  - usm_usuario_id (FK) โโโโโโโผโโโ   โ  - rol_nombre   โ
โ  - usm_modulo_id (FK)  โโโโโ โ  โ   โ  - ...          โ
โ  - usm_estado              โ โ  โ   โโโโโโโโโโโโโโโโโโโ
โ  - usm_creado              โ โ  โ            โ
โ  - usm_actualizado         โ โ  โ            โ
โ                            โ โ  โ            โผ
โ  UNIQUE(usuario, modulo)   โ โ  โ   โโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ   โ  tbl_roles_modulos  โ
         โ                     โ โ   โ                     โ
         โ                     โ โโโโโ  - rom_id (PK)      โ
         โ                     โ     โ  - rom_rol_id (FK)  โ
         โ                     โ     โ  - rom_modulo_idโโโ โ
         โ                     โ     โโโโโโโโโโโโโโโโโโโโโ โ
         โ                     โ                           โ
         โผ                     โผ                           โผ
โโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  tbl_modulos     โโโโโโโ
โ                  โ
โ  - mod_id (PK)   โ
โ  - mod_nombre    โ
โ  - mod_ruta      โ
โ  - mod_icono     โ
โ  - mod_estado    โ
โโโโโโโโโโโโโโโโโโโโ
```

## Flujo de Acceso a Mรณdulos

```
                          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ    Usuario hace login           โ
                          โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
                                           โ
                                           โผ
                          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ  Se obtiene ID de usuario       โ
                          โ  desde el token JWT             โ
                          โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
                                           โ
                                           โผ
                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ  Consultar tbl_usuarios_modulos               โ
                   โ  WHERE usm_usuario_id = ? AND usm_estado = 1  โ
                   โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                     โ
                    โโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ
                    โ                                โ
                    โผ                                โผ
         โโโโโโโโโโโโโโโโโโโโ            โโโโโโโโโโโโโโโโโโโโโโโโ
         โ  ยฟTiene mรณdulos   โ            โ                      โ
         โ  personalizados?  โ            โ                      โ
         โโโโโโโโโโโโโโโโโโโโ            โ                      โ
                    โ                     โ                      โ
         โโโโโโโโโโโโดโโโโโโโโโโโ          โ                      โ
         โ                     โ          โ                      โ
        Sร                    NO          โ                      โ
         โ                     โ          โ                      โ
         โผ                     โผ          โ                      โ
โโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ           โ
โ Obtener mรณdulos โ   โ  Consultar tbl_roles_modulosโ           โ
โ personalizados  โ   โ  WHERE rom_rol_id = ?       โ           โ
โ del usuario     โ   โ  JOIN tbl_modulos           โ           โ
โโโโโโโโโโโฌโโโโโโโโ   โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ           โ
          โ                      โ                              โ
          โ                      โ                              โ
          โโโโโโโโโโโโฌโโโโโโโโโโโโ                              โ
                     โ                                          โ
                     โผ                                          โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
         โ  Retornar lista de       โ                           โ
         โ  mรณdulos disponibles     โ                           โ
         โ  para el usuario         โ                           โ
         โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ                           โ
                    โ                                           โ
                    โผ                                           โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
         โ  Frontend construye      โ                           โ
         โ  menรบ de navegaciรณn      โ                           โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
                                                                โ
                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ
โ  MIDDLEWARE OPCIONAL: verificarModulo
โ
โโโโบ En cada request a rutas protegidas:
     1. Obtener mรณdulos del usuario (igual que arriba)
     2. Verificar si tiene el mรณdulo requerido
     3. Si Sร โ Continuar
     4. Si NO โ HTTP 403 Forbidden
```

## Casos de Uso Visualizados

### Caso 1: Usuario SIN mรณdulos personalizados
```
Usuario: Marรญa (ID: 6, Rol: Cliente)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           tbl_usuarios_modulos              โ
โ                                             โ
โ  (Vacรญo para Marรญa)                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
              Usa rol Cliente
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          tbl_roles_modulos                  โ
โ                                             โ
โ  Rol Cliente tiene: [1, 2, 3, 4, 5, 6]     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
      Marรญa ve: [1, 2, 3, 4, 5, 6]
```

### Caso 2: Usuario CON mรณdulos personalizados
```
Usuario: Juan (ID: 5, Rol: Cliente)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          tbl_usuarios_modulos               โ
โ                                             โ
โ  Juan tiene: [1, 3]  โ Personalizado        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
         Ignora mรณdulos del rol
                     โ
                     โผ
            Juan ve: [1, 3]
```

### Caso 3: Asignaciรณn de mรณdulos
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/v1/usuarios/5/modulos                      โ
โ  { "modulos": [1, 2] }                                โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. Eliminar asignaciones previas                   โ
โ     DELETE FROM tbl_usuarios_modulos                โ
โ     WHERE usm_usuario_id = 5                        โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. Insertar nuevas asignaciones                    โ
โ     INSERT INTO tbl_usuarios_modulos                โ
โ     (usm_usuario_id, usm_modulo_id, usm_estado)     โ
โ     VALUES                                          โ
โ     (5, 1, true),                                   โ
โ     (5, 2, true)                                    โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. Retornar รฉxito                                  โ
โ     { "mensaje": "Mรณdulos asignados" }              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Arquitectura de Capas

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PRESENTACIรN                              โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ  ControladorUsuarioModulos                         โ     โ
โ  โ  - asignarModulos()                                โ     โ
โ  โ  - obtenerModulos()                                โ     โ
โ  โ  - removerModulos()                                โ     โ
โ  โ  - limpiarModulos()                                โ     โ
โ  โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     DOMINIO                                  โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ  ServicioUsuarioModulos                            โ     โ
โ  โ  - Validaciones de negocio                         โ     โ
โ  โ  - Lรณgica de prioridad (personalizado vs rol)     โ     โ
โ  โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  INFRAESTRUCTURA                             โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ  RepositorioUsuarioModuloDB                        โ     โ
โ  โ  - Operaciones de base de datos                   โ     โ
โ  โ  - Queries con Lucid ORM                          โ     โ
โ  โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                     โ                                        โ
โ  โโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ  Entidades Lucid                                   โ     โ
โ  โ  - TblUsuariosModulos                              โ     โ
โ  โ  - TblRolesModulos                                 โ     โ
โ  โ  - TblModulos                                      โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  BASE DE DATOS                               โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โ
โ  โ tbl_usuarios  โ  โtbl_usuarios_     โ  โtbl_modulos  โ  โ
โ  โ               โ  โmodulos           โ  โ             โ  โ
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Endpoints y Responses

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/v1/usuarios/:id/modulos                          โ
โ  Body: { "modulos": [1, 2, 3] }                             โ
โ                                                             โ
โ  Response (200):                                            โ
โ  {                                                          โ
โ    "status": 200,                                           โ
โ    "title": "Mรณdulos asignados",                            โ
โ    "messages": ["Los mรณdulos han sido asignados..."]        โ
โ  }                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  GET /api/v1/usuarios/:id/modulos                           โ
โ                                                             โ
โ  Response (200):                                            โ
โ  {                                                          โ
โ    "status": 200,                                           โ
โ    "title": "Mรณdulos del usuario",                          โ
โ    "messages": ["Mรณdulos obtenidos exitosamente"],          โ
โ    "data": {                                                โ
โ      "modulos": [                                           โ
โ        {                                                    โ
โ          "id": 1,                                           โ
โ          "nombre": "usuarios",                              โ
โ          "nombreMostrar": "Usuarios",                       โ
โ          "ruta": "/usuarios",                               โ
โ          "icono": "users",                                  โ
โ          "estado": true                                     โ
โ        },                                                   โ
โ        ...                                                  โ
โ      ]                                                      โ
โ    }                                                        โ
โ  }                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  DELETE /api/v1/usuarios/:id/modulos/limpiar                โ
โ                                                             โ
โ  Response (200):                                            โ
โ  {                                                          โ
โ    "status": 200,                                           โ
โ    "title": "Mรณdulos limpiados",                            โ
โ    "messages": ["El usuario ahora usarรก los mรณdulos..."]    โ
โ  }                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Seguridad

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Request Incoming                        โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  Middleware:           โ
        โ  autenticacionJwt      โ
        โ  - Valida token        โ
        โ  - Extrae payload      โ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                 โ
                 โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  Middleware (opcional):โ
        โ  verificarModulo       โ
        โ  - Obtiene mรณdulos     โ
        โ  - Verifica acceso     โ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                 โ
                 โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  Controlador           โ
        โ  - Procesa request     โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Leyenda:**
- `(PK)` = Primary Key
- `(FK)` = Foreign Key
- `โโโบ` = Relaciรณn / Flujo
- `[ ]` = Array / Lista
